<!doctype html>
<html>
<head>
  <title>PacVis</title>
  <script type="text/javascript" src="static/vis-network.min.js"></script>
  <link href="static/vis.min.css" rel="stylesheet" type="text/css" />

  <!-- Vue Material https://vuematerial.io/getting-started -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic|Material+Icons">
  <link rel="stylesheet" href="/static/vue-material.min.css">
  <link rel="stylesheet" href="/static/vue-material.default.css">

  <script src="static/pacvis.js"></script>
  <link rel="stylesheet" href="static/pacvis.css">
  <!-- favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
</head>
<body>
<!-- <div id="target" class="target"></div> -->

<div id="app">
  <md-progress-bar md-mode="indeterminate"></md-progress-bar>
  <md-button class="leftpanel-show md-fab" id="leftpanel_show" title="Show Panel">
    <md-icon>menu</md-icon>
  </md-button>

  <div id="leftpanel" class="leftpanel">
    <div id="lefttoppanel" class="lefttoppanel">
      <md-card class="md-primary" md-with-hover>
          <md-card-media-actions>
            <md-card-media>
                <md-card-header>
                  <h1 class="md-title">PacVis</h1>
                </md-card-header>
            </md-card-media>

            <md-button class="md-icon-button" href="https://github.com/farseerfc/pacvis">
              <md-icon>launch</md-icon>
              <md-tooltip md-direction="left">GitHub repo</md-tooltip>
            </md-button>

            <md-button id="close_button" title="Hide Panel" class="md-icon-button md-accent">
              <md-icon>close</md-icon>
            </md-button>
          </md-card-media-actions>

        <md-card-expand>
          <md-card-actions md-alignment="space-between">

            <md-field>
              <md-icon>search</md-icon>
              <label>Search package name</label>
              <md-input v-model="search"></md-input>
            </md-field>
            <md-button class="md-icon-button">
              <md-icon>help_outline</md-icon>
            </md-button>


            <md-card-expand-trigger>
              <md-button class="md-icon-button">
                <md-icon>keyboard_arrow_down</md-icon>
              </md-button>
            </md-card-expand-trigger>
          </md-card-actions>

          <md-card-expand-content>
            <md-card-content>
              <div md-alignment="space-between">
                <md-field>
                  <label>Max Level</label>
                  <md-input v-model="maxlevel" type="number"></md-input>
                </md-field>
                <md-field>
                  <label>Max Depends</label>
                  <md-input v-model="maxdeps" type="number"></md-input>
                </md-field>
                <md-field>
                  <label>Max Required-By</label>
                  <md-input v-model="maxreqs" type="number"></md-input>
                </md-field>
              </div>
              <md-field>
                <label for="movie">Draw size</label>
                <md-select v-model="drawsize" name="drawsize" id="drawsize">
                  <md-option value="isize">Installed Size (-R)</md-option>
                  <md-option value="csize">Cascade Size (-Rc)</md-option>
                  <md-option value="cssize">Recursive Size (-Rcs)</md-option>
                </md-select>
              </md-field>
              <md-switch v-model="usemagic">Randomize topology level</md-switch>
              <md-switch v-model="byrepos">Layered by repositories</md-switch>
              <md-switch v-model="enablephysics">Enable physics after stabilized</md-switch>
              <md-switch v-model="aligntop">Align packages to top</md-switch>
              <md-switch v-model="showallvdeps">Show all virtual dependencies</md-switch>
              <md-switch v-model="straightline">Use straight lines as edges</md-switch>
              <md-card-actions>
                <md-button class="md-icon-button">
                  <md-icon>refresh</md-icon>
                </md-button>
              </md-card-actions>
            </md-card-content>
          </md-card-expand-content>
        </md-card-expand>
      </md-card>


    </div>
  </div>


</div>


<script type="text/javascript">

var currentsize="{{ options.drawsize }}";

var nodedata = {% raw nodes %};

function wrapDeps(list){
  var depsdom = "";
  if (list == "")
    return "<i>Nothing</i>";
  var count = 0;
  for (let dep of list.split(", ")) {
    depsdom += dep + ", ";
    count++;
    if(count%10 == 0){
      depsdom +="<br/>";
    }
  }
  return depsdom;
}

for(let nodeid in nodedata){
  let node = nodedata[nodeid];
  node.title = "<h4>" + node.label + "</h4>" +
    "<p>size: " + filesize(node[currentsize]) + "</p>" +
    "<p>groups: [" + wrapDeps(node.groups) + "]</p>" +
    "<p>depends: [" + wrapDeps(node.deps) + "]</p>" +
    "<p>required by:[" + wrapDeps(node.reqs) +"]</p>" +
    "<p>optdeps:[" + wrapDeps(node.optdeps) +"]</p>";
  node.value = size2value(node[currentsize]);
}

var nodes = new vis.DataSet(nodedata);

var edges = new vis.DataSet({% raw links %});

// create a network
var container = document.getElementById('target');
var data = {
  nodes: nodes,
  edges: edges
};
var physics = {
  maxVelocity: Math.floor(Math.sqrt(Math.sqrt(nodes.length))*200),
  hierarchicalRepulsion: {
    nodeDistance: Math.floor(Math.sqrt(Math.sqrt(nodes.length))*180),
    springLength: Math.floor(Math.sqrt(Math.sqrt(nodes.length))*100),
    springConstant: 1,
    damping: 0.1
  },
  timestep: 0.1,
  stabilization: {
    iterations: 30*Math.sqrt(nodes.length),
    updateInterval: 0.3*Math.sqrt(nodes.length),
  }
};
var options = {
  groups: {
    standalone: { shape: 'square', color: 'rgba(100,100,255,0.8)', size: 12 },
    normal: { shape: 'dot', color: 'rgba(255,171,64,0.8)'},
    group: { shape: 'triangle', size: 12, color: 'rgba(76,175,80,0.8)'},
    vdep: { shape: 'diamond', size: 12, color: 'rgba(205,220,57,0.8)'},
    explicit: { shape: 'dot', color: 'rgba(103,58,183,0.8)'},
    consolidated: { shape: 'star', color: 'rgba(255,0,0,0.8)', size: 12},
  },
  nodes: {
    scaling: {
      min: 5,
      max: 100,
      label: {
        min:5,
        max:100,
        maxVisible: 50,
        drawThreshold: 10
      }
    }
  },
  edges: {
    {% if options.straightline %}
    smooth: false,
    {% else %}
     smooth: {
         type: 'cubicBezier',
         forceDirection: "vertical",
         roundness: 0.5
     },
    {% end %}
     selectionWidth: 8,
     arrows: {
         to : true
     }
  },
  layout: {
     hierarchical: {
         direction: "UD",
         nodeSpacing: Math.floor(Math.sqrt(Math.sqrt(nodes.length))*100),
         treeSpacing: Math.floor(Math.sqrt(Math.sqrt(nodes.length))*180),
         levelSeparation: Math.floor(Math.sqrt(Math.sqrt(nodes.length))*50),
         blockShifting: false,
         edgeMinimization: false,
         parentCentralization: false
     },
    improvedLayout: true
  },
  interaction: {
    keyboard: {bindToWindow: false},
    hideEdgesOnDrag: true
  },
  {% if options.disableallphysics %}
  physics: false
  {% else %}
  physics: physics
  {% end %}
};

var network = null;

function pacvis(){
  network = new vis.Network(container, data, options);

  var debug_performance = {% if options.debugperformance %} true {% else %} false {% end %};

  network.on("startStabilizing", function (params) {
    document.title = 'PacVis';
  });
  network.on("stabilizationProgress", function (params) {
    document.title = 'PacVis | ' +  Math.round(params.iterations/params.total*100) + "%";
    document.querySelector('#loading_progress').MaterialProgress.setProgress(Math.round(params.iterations/params.total*100));
  });
  network.on("stabilizationIterationsDone", function (params) {
    if(debug_performance){
      document.title = "PacVis | loaded in: " + window.performance.now()/1000 ;
    }else{
      document.title = "PacVis";
    }
    document.querySelector('#loading_progress').MaterialProgress.setProgress(100);
    if( ! document.querySelector('#enablephysics').checked){
      network.setOptions({physics: false});
    }
  });

  network.on("selectNode", function (params) {
    // this is to fix a timing issue with chrome
    // when switching node beyond 2 hoops
    setTimeout(function (){
      selectPkg(nodes.get(params.nodes[0]));
    },1);
  });
  network.on("deselectNode", function (params) {
    deselectPkg();
  });
  network.on("click", function(params){
    neighbourhoodHighlight(params);
  });

}


var pacvisopts = {% raw optionsjson %};

pacvisDom();
</script>


<script src="https://unpkg.com/vue"></script>
<script src="https://unpkg.com/vue-material@beta"></script>
<script>
  Vue.use(VueMaterial.default)

  new Vue({
    el: '#app',
    data: () =>({
      maxlevel: 1000,
      maxdeps: 1000,
      maxreqs: 1000,
      drawsize: 'isize',
      usemagic: false,
      byrepos: false,
      enablephysics: false,
      aligntop: false,
      showallvdeps: false,
      straightline: false
    })
  })
</script>

</body>
</html>
